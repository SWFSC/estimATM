---
title: "Trawl Specimen Explorer"
author: "Kevin Stierhoff"
date: '`r format(Sys.time(), format = "%F %T", tz = "GMT", usetz = TRUE)`'
output:
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    number_sections: yes
css: css/ast.css
---

```{r set-up, echo=F, message=F, error=F, warning=F}
# Install and load pacman (library management package)
if (!require("pacman")) install.packages("pacman")

# Install and load required packages from CRAN ---------------------------------
pacman::p_load(tidyverse,plotly,lubridate,mapview,kableExtra,leaflet,
               here,bookdown,odbc,DBI,knitr,DT,fs,sf,reshape2)

# Install and load required packages from Github -------------------------------
pacman::p_load_gh("kstierhoff/surveyR")
pacman::p_load_gh("kstierhoff/atm")

# Define method of table generation (whether kable or xtable) for best formatting
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to')
if (is.null(doc.type)) {doc.type <- "html"}

# Knitr options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      out.width = "90%")

theme_set(theme_bw())

# Determine global knitr table format
if (doc.type == "latex") {
  knitr.format <- "latex"
} else {
  knitr.format <- "html" 
}
```

```{r user-settings}
# User-specified settings
get.nav <- F # Download vessel nav from ERDDAP
get.db  <- F # Extract data from trawl database (F for testing)
```

```{r project-settings}
# Get project name from directory
prj.name <- last(unlist(str_split(here(),"/")))

# Get all settings files
settings.files <- dir(here("Doc/settings"))

# Source survey settings file
prj.settings <- settings.files[str_detect(settings.files, paste0("settings_", prj.name, ".R"))]
source(here("Doc/settings", prj.settings))
```

```{r info}
# Character vector of scientific names (e.g., c("Sardinops sagax","Engraulis mordax",...))
cps.spp           <- c("Clupea pallasii","Engraulis mordax","Sardinops sagax",
                       "Scomber japonicus","Trachurus symmetricus")
```

```{r get-nav}
if (get.nav) {
  # Load existing nav data
  if (file.exists(here("Data/Nav/nav_data.Rdata"))) {
    load(here("Data/Nav/nav_data.Rdata"))
    
    # Calculate difference between max nav time and now
    nav.lag <- difftime(now(tzone = "UTC"), max(ymd_hms(nav$time)), units = "hours")
    
    # Get new erddap start date from max date
    erddap.survey.start <- max(date(nav$time)) - days(1)
  }
  
  if (nav.lag > 24) {
    # Generate ERDDAP URL
    dataURL <- URLencode(paste(
      "http://coastwatch.pfeg.noaa.gov/erddap/tabledap/fsuNoaaShip",
      erddap.vessel, ".csv0?", erddap.vars,
      "&time>=", erddap.survey.start, "&time<=", erddap.survey.end,
      sep = ""))
    
    # Download and parse ERDDAP nav data
    nav.temp <- data.frame(read.csv(dataURL, header = F, colClasses = erddap.classes, 
                                    row.names = NULL, skip = 0))
    names(nav.temp) <- erddap.headers
    
    # Filter to remove bad SST values
    nav.temp <- nav.temp %>% 
      mutate(long     = long - 360,
             SOG      = SOG * 1.94384,
             datetime = ymd_hms(time),
             SST      = na_if(SST, NaN),
             leg      = paste("Leg", cut(as.numeric(date(datetime)), 
                                         leg.breaks, labels = F))) %>%
      filter(is.nan(SOG) == F, SOG > 0, SOG < 15,
             between(lat, min(survey.lat), max(survey.lat)), 
             between(long, min(survey.long), max(survey.long)))
    
    # Append new nav data
    if (exists("nav")) {
      nav <- bind_rows(nav, nav.temp) %>% 
        distinct()
    } else {
      nav <- nav.temp
    }
  }
  
  # Convert nav to spatial
  # nav.sf <- st_as_sf(nav, coords = c("long","lat"), crs = crs.geog) 
  nav.sf <- st_as_sf(nav, coords = c("long","lat"), crs = crs.geog) 
  
  nav.paths.sf <- nav.sf %>% 
    group_by(leg) %>% 
    summarise(do_union = F) %>% 
    st_cast("LINESTRING")
  
  # Save results
  save(nav, nav.sf, nav.paths.sf, file = here("Data/Nav/nav_data.Rdata"))
} else {
  # Load nav data
  load(here("Data/Nav/nav_data.Rdata"))
}
```

```{r get-trawl-data}
if (get.db) {
  if (trawl.source == "SQL") {
    # Configure ODBC connection to TRAWL database
    trawl.con  <- dbConnect(odbc(), 
                            Driver = "SQL Server", 
                            Server = "161.55.235.187", 
                            Database = "Trawl", 
                            Trusted_Connection = "True")
  } else if (trawl.source == "Access") {
    # Copy trawl Access database
    haul.db <- dir_ls(file.path(survey.dir[survey.vessel.primary], "DATA/BIOLOGICAL/HAUL"),
                      regexp = trawl.db.access)
    
    file_copy(haul.db, here("Data/Trawl"), overwrite = TRUE)
    
    # Configure ODBC connection to TRAWL database
    trawl.con  <- dbConnect(odbc(), 
                            Driver = "Microsoft Access Driver (*.mdb, *.accdb)", 
                            DBQ = file.path(here("Data/Trawl"),trawl.db.access))
  }
  # Import trawl database tables
  catch.all	     <- tbl(trawl.con,"Catch") %>% collect()
  haul.all       <- tbl(trawl.con,"Haul") %>% collect()
  lengths.all    <- tbl(trawl.con,"Specimen") %>% collect()
  lengthFreq.all <- tbl(trawl.con,"LengthFrequency") %>% collect()
  spp.codes      <- tbl(trawl.con,"SpeciesCodes") %>% collect()
  
  # Close database channel
  dbDisconnect(trawl.con)
  
  # Save trawl data
  save(catch.all, haul.all, lengths.all, lengthFreq.all, spp.codes,
       file = here("Data/Trawl/checkTrawl_data.Rdata"))
  
} else {
  # Load trawl data
  load(here("Data/Trawl/checkTrawl_data.Rdata"))
  
}
```

```{r modify-data}
# Create startLatitudeDecimal and startLongitudeDecimal for Access data
if (trawl.source == "Access") {
  # Reformat haul data to match SQL
  haul.all <- haul.all %>% 
    mutate(
      startLatDecimal  =   startLatitudeDegrees + (startLatitudeMinutes/60),
      startLongDecimal = -(startLongitudeDegrees + (startLongitudeMinutes/60)),
      stopLatDecimal   =   stopLatitudeDegrees + (stopLatitudeMinutes/60),
      stopLongDecimal  = -(stopLongitudeDegrees + (stopLongitudeMinutes/60))) %>% 
      # equilibriumTime  =   ymd_hms(paste(as.character(trawlDate),
      #                                    format(haul.all$EquilibriumTime, 
      #                                           format = "%H:%M:%S"))),
      # haulBackTime     =   ymd_hms(paste(as.character(trawlDate),
      #                                    format(haul.all$haulbackTime,
      #                                           format = "%H:%M:%S")))) 
    mutate(haulbackTime = case_when(
      haulbackTime < EquilibriumTime ~ haulbackTime + days(1),
      TRUE ~ haulbackTime)) %>%
    rename(cruise = Cruise, ship = Ship, haul = Haul, 
           collection = Collection, notes = Notes)
  
  # Identify hauls where date of equilibriumTime or haulBackTime is incorrect
  eq.fix <- which(c(0, diff(haul.all$equilibriumTime)) < 0)
  hb.fix <- which(c(0, diff(haul.all$haulBackTime)) < 0)
  
  # Correct equilibriumTime or haulBackTime
  haul.all$equilibriumTime[eq.fix] <- haul.all$equilibriumTime[eq.fix] + days(1)
  haul.all$haulBackTime[eq.fix]    <- haul.all$haulBackTime[eq.fix] + days(1)
  
  # Reformat length frequency data to match SQL
  lengths.all <- lengths.all %>% 
    rename(cruise = Cruise, ship = Ship, haul = Haul, 
           collection = Collection, species = Species)
  
  # Reformat length frequency data to match SQL
  lengthFreq.all <- lengthFreq.all %>% 
    rename(cruise = Cruise, ship = Ship, haul = Haul, collection = Collection, 
           species = Species, length = Length, lengthType = LengthType, 
           sexUnknown = NotDetermined, male = Male, activeFemale = ActiveFemale, 
           inactiveFemale = InactiveFemale, totalFemale = TotalFemale, 
           subSampleNumber = SubSampleNumber)
} else if (trawl.source == "SQL") {
  haul.all <- haul.all %>% 
    mutate(
      equilibriumTime = ymd_hms(equilibriumTime),
      haulBackTime    = ymd_hms(haulBackTime))
}

# Select bad trawls
haul.bad <- haul.all %>% 
  filter(trawlPerformance %in% trawl.performance) 

# Classify hauls by season (spring or summer)
haul.all <- haul.all %>% 
  # Remove bad trawls
  filter(!trawlPerformance %in% trawl.performance) %>% 
  mutate(season = case_when(
    month(equilibriumTime) < 6 ~ "spring",
    TRUE ~ "summer"))

# Get only hauls from current survey
haul <- filter(haul.all, cruise %in% cruise.name) %>% 
  mutate(duration = difftime(haulBackTime, equilibriumTime, units = "mins"), # Calculate duration
         cluster  = cumsum(c(0, diff(equilibriumTime)) > 12) + 1) # Assign cluster

# Find midpoint of each haul as the mean lat/lon
haul.mid <- haul %>% 
  group_by(cluster, haul) %>% 
  summarise(
    lat  = mean(c(startLatDecimal, stopLatDecimal)),
    long = mean(c(startLongDecimal, stopLongDecimal))) 

# Find midpoint of each haul cluster as the average of haul midpoints
cluster.mid <- haul.mid %>% 
  group_by(cluster) %>% 
  summarise(
    lat  = mean(lat),
    long = mean(long))
```

```{r process-catch-data, message=FALSE}
# Filter catch data
catch <- catch.all %>% 
  left_join(select(spp.codes, species, scientificName, commonName)) %>% 
  filter(cruise %in% cruise.name & ship %in% cruise.ship & 
           scientificName %in% cps.spp & netSampleType == 'codend') %>% 
  left_join(select(haul, haul, cluster)) %>% 
  mutate(key = paste(haul, scientificName),
         totalWeight = subSampleWtkg + remainingSubSampleWtkg)

if (nrow(catch) > 0) {
  # Summarize trawl catch by species
  haul.summ.wt <- dcast(select(catch, haul, cluster, scientificName, totalWeight),
                        haul + cluster ~ scientificName, sum)
  
  # Add species with zero total weight
  if (is.null(haul.summ.wt$`Engraulis mordax`))      {haul.summ.wt$`Engraulis mordax`      <- 0}
  if (is.null(haul.summ.wt$`Sardinops sagax`))       {haul.summ.wt$`Sardinops sagax`       <- 0}
  if (is.null(haul.summ.wt$`Scomber japonicus`))     {haul.summ.wt$`Scomber japonicus`     <- 0}
  if (is.null(haul.summ.wt$`Trachurus symmetricus`)) {haul.summ.wt$`Trachurus symmetricus` <- 0}
  if (is.null(haul.summ.wt$`Clupea pallasii`))       {haul.summ.wt$`Clupea pallasii`       <- 0}
  if (is.null(haul.summ.wt$`Atherinopsis californiensis`)) {haul.summ.wt$`Atherinopsis californiensis` <- 0}
  
  # Calculate total weight of all CPS species
  haul.summ.wt <- haul.summ.wt %>% 
    mutate(AllCPS = rowSums(.[, 3:ncol(.)]))
  
  # Summarise catch by cluster
  cluster.summ.wt <- haul.summ.wt %>% 
    select(-haul, -AllCPS) %>% 
    group_by(cluster) %>% 
    summarise_all(list(sum)) %>% 
    mutate(AllCPS = rowSums(.[, 2:ncol(.)])) %>% 
    right_join(cluster.mid) %>% 
    rename("Jacksmelt"  = "Atherinopsis californiensis",
           "PacHerring" = "Clupea pallasii",
           "Anchovy"    = "Engraulis mordax",
           "Sardine"    = "Sardinops sagax",
           "PacMack"    = "Scomber japonicus",
           "JackMack"   = "Trachurus symmetricus") %>% 
    replace(is.na(.), 0)
  
  # Add lat/long to haul summary for plotting
  haul.summ.wt <- haul.summ.wt %>% 
    right_join(haul.mid) %>% 
    rename("Jacksmelt"  = "Atherinopsis californiensis",
           "PacHerring" = "Clupea pallasii",
           "Anchovy"    = "Engraulis mordax",
           "Sardine"    = "Sardinops sagax",
           "PacMack"    = "Scomber japonicus",
           "JackMack"   = "Trachurus symmetricus") %>% 
    replace(is.na(.), 0)
  
} else {
  # Summarize trawl catch by species
  haul.summ.wt <- bind_cols(select(haul, haul, cluster),
                            data.frame(
                              "Jacksmelt"  = rep(0, nrow(haul)),
                              "PacHerring" = rep(0, nrow(haul)),
                              "Anchovy"    = rep(0, nrow(haul)),
                              "Sardine"    = rep(0, nrow(haul)),
                              "PacMack"    = rep(0, nrow(haul)),
                              "JackMack"   = rep(0, nrow(haul)),
                              "AllCPS"     = rep(0, nrow(haul)))) %>% 
    right_join(haul.mid)
  
  # Summarise catch by cluster
  cluster.summ.wt <- haul.summ.wt %>% 
    select(-haul, -AllCPS) %>% 
    group_by(cluster) %>% 
    summarise_all(funs(sum)) %>% 
    mutate(AllCPS = rowSums(.[, 2:ncol(.)])) %>% 
    right_join(cluster.mid) 
}

# Prepare catch data for plotting ----------------------------------------------
# Select and rename trawl data for pie charts
catch.pie <- cluster.summ.wt %>% 
  select(cluster, long, lat, Anchovy, JackMack, 
         Jacksmelt, PacHerring, PacMack, Sardine, AllCPS) %>% 
  st_as_sf(coords = c("long","lat"), crs = crs.geog)

# Project pie data
catch.pie <- project_sf(catch.pie, crs.proj) 

# Convert haul data for plotting
haul.catch <- haul.summ.wt %>% 
  st_as_sf(coords = c("long", "lat"), crs = crs.geog) 

haul.catch <- project_sf(haul.catch, crs = crs.proj)
```

```{r summarise-hauls}
# Create haul paths from starts and ends
haul.paths <- select(haul, haul, lat = startLatDecimal, long = startLongDecimal) %>% 
  bind_rows(select(haul, haul, lat = stopLatDecimal, long = stopLongDecimal)) %>% 
  arrange(haul) %>% 
  st_as_sf(coords = c("long","lat"), crs = crs.geog) %>% 
  group_by(haul) %>% 
  summarise(do_union = F) %>% 
  st_cast("LINESTRING") %>% 
  left_join(select(haul.catch, -X, -Y, -cluster)) %>% 
  mutate(
    distance = round(as.numeric(st_length(.))/1852,1),
    label    = paste("Haul", haul),
    popup    = paste('<b>Haul:', haul, '</b><br/>',
                     'Anchovy:', Anchovy, 'kg<br/>',
                     'Sardine:', Sardine, 'kg<br/>',
                     'Jack mackerel:', JackMack, 'kg<br/>',
                     'P. herring:', PacHerring, 'kg<br/>',
                     'P. mackerel:', PacMack, 'kg<br/>',
                     'All CPS:', AllCPS, 'kg')) 

# Add coordinates if using the Access database (columns do not exist in SQL database)
if (trawl.source == "Access") {
  haul.paths <- haul.paths %>% 
    left_join(select(haul, haul, 
                     startLatDeg   = startLatitudeDegrees,
                     startLatMin   = startLatitudeMinutes,
                     startLongDeg  = startLongitudeDegrees,
                     startLongMin  = startLongitudeMinutes,
                     stopLatDeg    = stopLatitudeDegrees,
                     stopLatMin    = stopLatitudeMinutes,
                     stopLongDeg   = stopLongitudeDegrees,
                     stopLongMin   = stopLongitudeMinutes))  
} else {
  # Do nothing for now
  haul.paths <- haul.paths
}

# Convert haul locations to sf
haul.locs.sf <- haul.mid %>% 
  mutate(label = paste("Haul", haul)) %>% 
  st_as_sf(coords = c("long","lat"), crs = crs.geog) 

# Convert cluster locations to sf
cluster.locs.sf <- cluster.mid %>% 
  mutate(label = paste("Cluster", cluster)) %>% 
  st_as_sf(coords = c("long","lat"), crs = crs.geog) 

# Convert haul catch to sf and create labels
cluster.catch.sf <- catch.pie %>%
  st_as_sf(coords = c("X","Y"), crs = crs.proj) %>%
  st_transform(crs = crs.geog) %>% 
  mutate(
    label = paste("Cluster", cluster),
    popup = paste('<b>Cluster:', cluster, '</b><br/>',
                  'Anchovy:', Anchovy, 'kg<br/>',
                  'Sardine:', Sardine, 'kg<br/>',
                  'Jack mackerel:', JackMack, 'kg<br/>',
                  'P. herring:', PacHerring, 'kg<br/>',
                  'P. mackerel:', PacMack, 'kg<br/>',
                  'All CPS:', AllCPS, 'kg'))
```

```{r process-trawl-length-data}
# Process trawl length data -------------------------------------------------------
if (nrow(lengthFreq.all) > 0) {
  # Process binned length data from all surveys
  lengths.expanded.all <- lengthFreq.all %>%
    left_join(select(spp.codes, species, scientificName, commonName)) %>%
    # Remove samples from 4meshnet
    filter(netSampleType == 'codend') %>%
    select(cruise, ship, haul, collection, species, scientificName, length,
           lengthType, sexUnknown, male, totalFemale) %>% 
    gather(sex, count, -cruise, -ship, -haul, -collection, -species, 
           -scientificName, -lengthType, -length) %>%
    filter(count != 0) %>% 
    droplevels() %>% 
    # Expand data frame by counts
    uncount(weights = count)
  
  # Extract data by length type (SL, FL, and TL) and combine
  lengths.expanded.final <- data.frame()
  
  for (i in unique(lengths.expanded.all$lengthType)) {
    l.temp <- filter(lengths.expanded.all, lengthType == i)
    names(l.temp)[names(l.temp) == 'length'] <- as.character(i)
    lengths.expanded.final <- bind_rows(lengths.expanded.final, l.temp)
  }
  
  # Add missing length columns
  if (is.null(lengths.expanded.final$FL)) {lengths.expanded.final$FL <- NA}
  if (is.null(lengths.expanded.final$SL)) {lengths.expanded.final$SL <- NA}
  if (is.null(lengths.expanded.final$TL)) {lengths.expanded.final$TL <- NA}
  if (is.null(lengths.expanded.final$ML)) {lengths.expanded.final$ML <- NA}
  
  # Remove unwanted columns and rename length columns  
  lengths.expanded.final <- lengths.expanded.final %>% 
    rename(forkLength_mm     = FL,
           standardLength_mm = SL,
           totalLength_mm    = TL,
           mantleLength_mm   = ML) %>% 
    mutate(
      flaggedData = "N",
      isRandomSample = "Y",
      binned = TRUE)
}

lengths.all <- lengths.all  %>% 
  # Add scientific and common names
  left_join(select(spp.codes, species, scientificName, commonName)) %>%
  # Filter for CPS species and market squid
  filter(scientificName %in% c(cps.spp, "Doryteuthis (Loligo) opalescens")) %>% 
  # Select desired columns
  select(cruise, ship, haul, collection, species, individual_ID, 
         scientificName, commonName, specimenNumber, 
         standardLength_mm, forkLength_mm, totalLength_mm, mantleLength_mm,
         sex, weightg, isRandomSample, flaggedData) %>%
  # Convert individual IDs to numeric
  mutate(individual_ID = as.numeric(individual_ID)) %>% 
  # Standardize sex values
  mutate(sex = tolower(trimws(sex)),
         binned = FALSE) %>% 
  bind_rows(lengths.expanded.final) %>% 
  # Create unique key and replace unused sex categories
  mutate(key = paste(cruise, ship, haul, collection, species, specimenNumber),
         sex = str_replace(sex,"totalFemale","female"),
         sex = str_replace(sex,"sexUnknown","unknown"),
         sex = replace_na(sex, "missing"),
         label = paste("Haul: ", haul, ", Collection: ", collection, 
                       ", Specimen: ", specimenNumber), sep = "") %>% 
  # Add season from haul
  left_join(select(haul.all, cruise, ship, haul, season)) %>% 
  filter(scientificName %in% c(cps.spp, "Doryteuthis (Loligo) opalescens"))

# Convert lengths to total length for TS estimates ---------------------------
lengths.all  <- lengths.all %>%
  mutate(
    totalLength_mm = case_when(
      scientificName == "Clupea pallasii" ~ 
        convert_length("Clupea pallasii", .$forkLength_mm, "FL", "TL"),
      scientificName == "Engraulis mordax" ~ 
        convert_length("Engraulis mordax", .$standardLength_mm, "SL", "TL"),
      scientificName == "Sardinops sagax" ~ 
        convert_length("Sardinops sagax", .$standardLength_mm, "SL", "TL"),
      scientificName == "Scomber japonicus" ~ 
        convert_length("Scomber japonicus", .$forkLength_mm, "FL", "TL"),
      scientificName == "Trachurus symmetricus" ~ 
        convert_length("Trachurus symmetricus", .$forkLength_mm, "FL", "TL"),
      scientificName == "Doryteuthis (Loligo) opalescens" ~  as.numeric(mantleLength_mm)),
    missing.weight = case_when(
      is.na(weightg)   ~ TRUE, 
      TRUE ~ FALSE),
    missing.length = case_when(
      is.na(totalLength_mm) & !scientificName == "Doryteuthis (Loligo) opalescens" ~ TRUE,
      is.na(mantleLength_mm) & scientificName == "Doryteuthis (Loligo) opalescens" ~ TRUE,
      TRUE ~ FALSE)) %>% 
  mutate(totalLength_mm = round(totalLength_mm),
         mantleLength_mm = round(mantleLength_mm))

# Get max TL for plotting L/W models
L.max <- lengths.all %>% 
  filter(scientificName %in% cps.spp) %>%
  group_by(scientificName) %>% 
  summarise(max.TL = max(totalLength_mm, na.rm = TRUE))

L.max.sq <- lengths.all %>% 
  filter(scientificName == "Doryteuthis (Loligo) opalescens") %>% 
  group_by(scientificName) %>% 
  summarise(max.ML = max(mantleLength_mm, na.rm = TRUE))

# Data frame for storing results
lw.df <- data.frame()

# Generate length/weight curves
for (i in unique(L.max$scientificName)) {
  # Create a length vector for each species
  L <- seq(0, L.max$max.TL[L.max$scientificName == i])
  
  # Calculate weights from lengths
  W <- estimate_weight(i, L, season = tolower(survey.season))
  
  # Combine results
  lw.df <- bind_rows(lw.df, data.frame(scientificName = i, L, W))
}

# Estimate missing weights from lengths -------------------------------------------------------
# Use Palance et al. 2019 models to estimate missing L and W
lengths.all <- lengths.all %>% 
  mutate(
    weightg = case_when(
      is.na(weightg) ~ estimate_weight(.$scientificName, .$totalLength_mm, season = tolower(survey.season)),
      TRUE  ~ weightg),
    totalLength_mm = case_when(
      is.na(totalLength_mm) ~ estimate_length(.$scientificName, .$weightg, season = tolower(survey.season)),
      TRUE ~ totalLength_mm),
    K = case_when(
      !scientificName == "Doryteuthis (Loligo) opalescens" ~ round((weightg/totalLength_mm*10^3)*100),
      TRUE ~ round((weightg/mantleLength_mm*10^3)*100)))

# Filter samples with missing length AND weight measurements
bad.lengths <-  lengths.all %>% 
  # Filter for cruise specific data
  filter(cruise %in% cruise.name & ship %in% cruise.ship & 
           scientificName %in% c(cps.spp, "Doryteuthis (Loligo) opalescens") & 
           toupper(isRandomSample) == "Y") %>% 
  filter(is.na(totalLength_mm), is.na(weightg))

# Filter length data for current cruise and vessel
lengths <- lengths.all %>% 
  filter(cruise %in% cruise.name & ship %in% cruise.ship & 
           scientificName %in% c(cps.spp, "Doryteuthis (Loligo) opalescens") & 
           toupper(isRandomSample) == "Y")

# Summarize Fulton's condition factor (K) for identifying outliers
K.summ <- lengths %>%
  filter(!is.na(K)) %>% 
  group_by(scientificName) %>%
  summarise(
    K.lower = quantile(K, probs = 0.001),
    K.upper = quantile(K, probs = 0.999))

# Filter binned lengths for the present survey
lengths.binned <- lengths.all %>%
  filter(cruise %in% cruise.name & ship %in% cruise.ship & 
           scientificName %in% c(cps.spp, "Doryteuthis (Loligo) opalescens") & 
           binned == TRUE) 

# If binned lengths are present, plot their distribution
if (nrow(lengths.binned) > 0) {
  binned.length.plot <- ggplot(lengths.binned, aes(totalLength_mm)) +
    geom_histogram() + 
    facet_wrap(~scientificName, scales = "free") + 
    xlab("Length (cm)") + ylab("Count") +
    theme_bw() +
    theme(strip.background.x = element_blank(),
          strip.text.x = element_text(face = "italic"))
  
  # Save plot
  ggsave(binned.length.plot,
         file = here("Figs/fig_binned_length_histogram.png"),
         height = 6, width = 6)
}
```  

```{r flag-outliers}
# Select outliers
outliers <- lengths %>% 
  left_join(K.summ) %>% 
  filter(K <= K.lower | K >= K.upper) %>% 
  filter(binned == FALSE) %>% 
  mutate(key = paste(collection, species, specimenNumber),
         outlier = TRUE) %>% 
  select(key, outlier)

# Add outlier flag to length data
lengths <- lengths %>% 
  mutate(key = paste(collection, species, specimenNumber)) %>% 
  left_join(outliers) %>% 
  left_join(select(haul, haul, datetime = equilibriumTime)) %>% 
  mutate(leg = cut(as.numeric(date(datetime)), leg.breaks, labels = F))
```

# Overview
This is a tool used to visualize and conduct QA/QC of trawl specimen data collected during Acoustic-Trawl (AT) surveys of coastal pelagic fish species (CPS) in the California Current Ecosystem. 

The data below was collected during the **`r survey.name.long` (`r survey.name`)**. 

# Length-weight summary

View the length (cm) and weight (g) range for each species.

## CPS

```{r length-summary}
# Summarise lengths by species
lengths %>% 
  filter(!scientificName == "Doryteuthis (Loligo) opalescens") %>% 
  group_by(scientificName) %>% 
  summarise(
    TL.min = round(min(totalLength_mm, na.rm = TRUE)/10,0),
    TL.max = round(max(totalLength_mm, na.rm = TRUE)/10,0),
    SL.min = round(min(standardLength_mm, na.rm = TRUE)/10,0),
    SL.max = round(max(standardLength_mm, na.rm = TRUE)/10,0),
    FL.min = round(min(forkLength_mm, na.rm = TRUE)/10,0),
    FL.max = round(max(forkLength_mm, na.rm = TRUE)/10,0),
    w.min  = round(min(weightg, na.rm = TRUE),1),
    w.max  = round(max(weightg, na.rm = TRUE),1)) %>% 
  datatable(rownames = FALSE)
```

## Market squid

```{r length-summary-squid}
# Summarise lengths by species
lengths %>% 
  filter(scientificName == "Doryteuthis (Loligo) opalescens") %>% 
  group_by(scientificName) %>% 
  summarise(
    ML.min = round(min(mantleLength_mm, na.rm = TRUE)/10,0),
    ML.max = round(max(mantleLength_mm, na.rm = TRUE)/10,0),
    w.min  = round(min(weightg, na.rm = TRUE),1),
    w.max  = round(max(weightg, na.rm = TRUE),1)) %>% 
  datatable(rownames = FALSE)
```

# Length-frequencies
Length frequency by cruise leg. 

```{r length-freq-leg}
ggplot(lengths, aes(totalLength_mm, group = factor(leg))) +
  geom_histogram(aes(fill = factor(leg)), alpha = 0.5) + 
  facet_wrap(~scientificName, scales = "free") +
  scale_fill_viridis_d("Leg") +
  xlab("Length (mm)") + ylab("Frequency") +
  theme(strip.background.x = element_blank(),
        strip.text.x = element_text(face = "bold.italic"))

ggsave(here("Figs/fig_length_frequency_leg.png"),
       height = 7, width = 10)
```

# Outliers

## Outlier plot  

View the distribution of Fulton's Condition Factor ($K = (w/TL^3)*100$) for each species. Specimens that fall outside the 0.01 and 99.9 percentiles are identified as potential outliers (`flaggedData` = Y).  

```{r, fig.pos="hold"}
# Plot lengths and bounds of outliers
lengths %>% 
  # filter(!scientificName == "Doryteuthis (Loligo) opalescens") %>% 
  ggplot(aes(K)) + geom_histogram() +
  geom_vline(data = K.summ, aes(xintercept =  K.lower), linetype = "dashed") +
  geom_vline(data = K.summ, aes(xintercept =  K.upper), linetype = "dashed") +
  facet_wrap(~scientificName, scales = "free") +
  xlab("Fulton's Condition Factor (K)") +
  ylab("Frequency") +
  theme_bw() +
  theme(strip.background.x = element_blank(),
        strip.text.x = element_text(face = "italic"))
```

## Outlier table-All  

Other specimens may have been flagged by trawl personnel. The table below lists all specimens identified as potential outliers, regardless of whether they've been flagged or reviewed (see `flaggedData`).   

```{r outlier-table-all}
# Select outliers
lengths %>% 
  left_join(K.summ) %>% 
  filter(K <= K.lower | K >= K.upper) %>% 
  filter(binned == FALSE) %>% 
  select(haul, collection, scientificName, specimenNumber, SL = standardLength_mm, 
         FL = forkLength_mm, TL = totalLength_mm, ML = mantleLength_mm, weightg, 
         sex, K, flaggedData) %>%
  arrange(scientificName, haul, specimenNumber) %>% 
  datatable(rownames = FALSE)
```

## Outlier table-New  

Only show those specimens identified as outliers based on $K$ that have not yet been flagged (`flaggedData` = N). 

```{r outlier-table-new}
# Select only outliers that have not yet been flagged
# Select outliers
lengths %>% 
  left_join(K.summ) %>% 
  filter(K <= K.lower | K >= K.upper) %>% 
  filter(binned == FALSE,
         is.na(flaggedData)) %>% 
  select(haul, collection, scientificName, specimenNumber, SL = standardLength_mm, 
         FL = forkLength_mm, TL = totalLength_mm, ML = mantleLength_mm,
         weightg, sex, K, flaggedData) %>%
  arrange(scientificName, haul, specimenNumber) %>% 
  datatable(rownames = FALSE)
```

# Missing data
## Length measurements

Specimens with missing length measurements. It is expected that standard length is measured for Pacific Sardine and Northern Anchovy, and that fork length is measured for Pacific Herring, Pacific Mackerel, and Jack Mackerel. If missing, length is estimated from the measured weight.

```{r missing-lengths}
# Select only outliers that have not yet been flagged
# Select outliers
lengths %>% 
  filter(missing.length == TRUE, is.na(flaggedData)) %>% 
  select(haul, collection, scientificName, specimenNumber, SL = standardLength_mm, 
         FL = forkLength_mm, TL = totalLength_mm, ML = mantleLength_mm, 
         weightg, sex, K, flaggedData) %>%
  arrange(scientificName, haul, specimenNumber) %>% 
  datatable(rownames = FALSE)
```

## Weight measurements

Self explanatory; weight is missing and estimated from total length.

```{r missing-weights}
# Select only outliers that have not yet been flagged
# Select outliers
lengths %>% 
  filter(missing.weight == TRUE, is.na(flaggedData)) %>% 
  select(haul, collection, scientificName, specimenNumber, SL = standardLength_mm, 
         FL = forkLength_mm, TL = totalLength_mm, ML = mantleLength_mm, 
         weightg, sex, K, flaggedData) %>%
  arrange(scientificName, haul, specimenNumber) %>% 
  datatable(rownames = FALSE)
```

## Length and weight measurements

Self explanatory; both length and weight measurements are missing, so K may not be calculated.

```{r missing-lengths-weights}
# Select only outliers that have not yet been flagged
# Select outliers
bad.lengths %>% 
  select(haul, collection, scientificName, specimenNumber, SL = standardLength_mm, 
         FL = forkLength_mm, TL = totalLength_mm, ML = mantleLength_mm, 
         weightg, sex, K, flaggedData) %>%
  arrange(scientificName, haul, specimenNumber) %>% 
  datatable(rownames = FALSE)
```

## Sex classification

Self explanatory; sex is not specified as either male, female, or unknown.

```{r missing-sex}
# Select only outliers that have not yet been flagged
# Select outliers
lengths %>% 
  filter(sex == "missing") %>% 
  select(haul, collection, scientificName, specimenNumber, SL = standardLength_mm, 
         FL = forkLength_mm, TL = totalLength_mm, ML = mantleLength_mm, 
         weightg, sex, K, flaggedData) %>%
  arrange(scientificName, haul, specimenNumber) %>% 
  datatable(rownames = FALSE)
```

# Interactive plots
The plots below provide information about trawl specimens (e.g., length, weigth, haul, collection, and specimen number) when you hover over points with the mouse. You may zoom, pan, toggle spike-lines, etc using the menu above each graph (available when the mouse is in the plot area). **<span style="color:red">Red</span>** and **<span style="color:blue">blue</span>** points are specimens that had missing length and weight measurements, respectively. Points with **bold black** outlines have already been "flagged" in the database but may or may not have been corrected.  

## Sardine

```{r sardine-data}
# Select species
scientificName.sub <- "Sardinops sagax"

# Subset lengths and models
lengths.sub     <- filter(lengths, scientificName == scientificName.sub)
lengths.all.sub <- filter(lengths.all, 
                          scientificName == scientificName.sub,
                          season ==  tolower(survey.season))
lw.df.sub <- filter(lw.df, scientificName == scientificName.sub)

if (nrow(lengths.sub) > 0) {
  # Plot L/W data from past and current survey -----------------------------------
  lw.plot <- ggplot() + 
    # Plot L/W data from all years/surveys
    geom_point(data = lengths.all.sub, 
               aes(totalLength_mm, weightg),
               colour = "gray70", alpha = 0.3) +
    # Plot L/W data for current survey
    geom_point(data = lengths.sub,
               aes(totalLength_mm, weightg, fill = sex, 
                   colour = outlier, label = label), 
               shape = 21, alpha = 0.9) + 
    scale_fill_manual(name = "Sex", values = c("female" = "pink", "male" = "lightblue",
                                               "unknown" = "#FFC926", "missing" = "purple")) +
    scale_colour_manual(name = "Flagged", values = c("NA" = NA, "TRUE" = "black")) +
    # Plot seasonal length models for each species
    geom_line(data = lw.df.sub, aes(L, W), alpha = 0.75, colour = "gray50", linetype = 'dashed') +
    # Plot individuals with missing lengths and weights
    geom_point(data = filter(lengths.sub, missing.length == TRUE), 
               aes(totalLength_mm, weightg, label = label),
               shape = 21, fill = 'red',  size = 2.5, colour = NA, alpha = 0.5) +
    geom_point(data = filter(lengths.sub, missing.weight == TRUE), 
               aes(totalLength_mm, weightg, label = label),
               shape = 21, fill = 'blue', size = 2.5, colour = NA, alpha = 0.5) +
    # Format plot
    xlab("Total length (mm)") + ylab("Mass (g)") 
  
  ggplotly(lw.plot, dynamicTicks = TRUE) 
} else {
  print("No specimens present.")
}
```

## Anchovy

```{r anchovy-data}
# Select species
scientificName.sub <- "Engraulis mordax"

# Subset lengths and models
lengths.sub     <- filter(lengths, scientificName == scientificName.sub)
lengths.all.sub <- filter(lengths.all, 
                          scientificName == scientificName.sub,
                          season ==  tolower(survey.season))
lw.df.sub <- filter(lw.df, scientificName == scientificName.sub)

if (nrow(lengths.sub) > 0) {
  # Plot L/W data from past and current survey -----------------------------------
  lw.plot <- ggplot() + 
    # Plot L/W data from all years/surveys
    geom_point(data = lengths.all.sub, 
               aes(totalLength_mm, weightg),
               colour = "gray70", alpha = 0.3) +
    # Plot L/W data for current survey
    geom_point(data = lengths.sub,
               aes(totalLength_mm, weightg, fill = sex, 
                   colour = outlier, label = label), 
               shape = 21, alpha = 0.9) + 
    scale_fill_manual(name = "Sex", values = c("female" = "pink", "male" = "lightblue",
                                               "unknown" = "#FFC926", "missing" = "purple")) +
    scale_colour_manual(name = "Flagged", values = c("NA" = NA, "TRUE" = "black")) +
    # Plot seasonal length models for each species
    geom_line(data = lw.df.sub, aes(L, W), alpha = 0.75, colour = "gray50", linetype = 'dashed') +
    # Plot individuals with missing lengths and weights
    geom_point(data = filter(lengths.sub, missing.length == TRUE), 
               aes(totalLength_mm, weightg, label = label),
               shape = 21, fill = 'red',  size = 2.5, colour = NA, alpha = 0.5) +
    geom_point(data = filter(lengths.sub, missing.weight == TRUE), 
               aes(totalLength_mm, weightg, label = label),
               shape = 21, fill = 'blue', size = 2.5, colour = NA, alpha = 0.5) +
    # Format plot
    xlab("Total length (mm)") + ylab("Mass (g)") 
  
  ggplotly(lw.plot, dynamicTicks = TRUE) 
} else {
  print("No specimens present.")
}
```

## Pacific mackerel

```{r mack-data}
# Select species
scientificName.sub <- "Scomber japonicus"

# Subset lengths and models
lengths.sub     <- filter(lengths, scientificName == scientificName.sub)
lengths.all.sub <- filter(lengths.all, 
                          scientificName == scientificName.sub,
                          season ==  tolower(survey.season))
lw.df.sub <- filter(lw.df, scientificName == scientificName.sub)

if (nrow(lengths.sub) > 0) {
  # Plot L/W data from past and current survey -----------------------------------
  lw.plot <- ggplot() + 
    # Plot L/W data from all years/surveys
    geom_point(data = lengths.all.sub, 
               aes(totalLength_mm, weightg),
               colour = "gray70", alpha = 0.3) +
    # Plot L/W data for current survey
    geom_point(data = lengths.sub,
               aes(totalLength_mm, weightg, fill = sex, 
                   colour = outlier, label = label), 
               shape = 21, alpha = 0.9) + 
    scale_fill_manual(name = "Sex", values = c("female" = "pink", "male" = "lightblue",
                                               "unknown" = "#FFC926", "missing" = "purple")) +
    scale_colour_manual(name = "Flagged", values = c("NA" = NA, "TRUE" = "black")) +
    # Plot seasonal length models for each species
    geom_line(data = lw.df.sub, aes(L, W), alpha = 0.75, colour = "gray50", linetype = 'dashed') +
    # Plot individuals with missing lengths and weights
    geom_point(data = filter(lengths.sub, missing.length == TRUE), 
               aes(totalLength_mm, weightg, label = label),
               shape = 21, fill = 'red',  size = 2.5, colour = NA, alpha = 0.5) +
    geom_point(data = filter(lengths.sub, missing.weight == TRUE), 
               aes(totalLength_mm, weightg, label = label),
               shape = 21, fill = 'blue', size = 2.5, colour = NA, alpha = 0.5) +
    # Format plot
    xlab("Total length (mm)") + ylab("Mass (g)")  
  
  ggplotly(lw.plot, dynamicTicks = TRUE) 
} else {
  print("No specimens present.")
}
```

## Jack mackerel

```{r jack-data}
# Select species
scientificName.sub <- "Trachurus symmetricus"

# Subset lengths and models
lengths.sub     <- filter(lengths, scientificName == scientificName.sub)
lengths.all.sub <- filter(lengths.all, 
                          scientificName == scientificName.sub,
                          season ==  tolower(survey.season))
lw.df.sub <- filter(lw.df, scientificName == scientificName.sub)

if (nrow(lengths.sub) > 0) {
  # Plot L/W data from past and current survey -----------------------------------
  lw.plot <- ggplot() + 
    # Plot L/W data from all years/surveys
    geom_point(data = lengths.all.sub, 
               aes(totalLength_mm, weightg),
               colour = "gray70", alpha = 0.3) +
    # Plot L/W data for current survey
    geom_point(data = lengths.sub,
               aes(totalLength_mm, weightg, fill = sex, 
                   colour = outlier, label = label), 
               shape = 21, alpha = 0.9) + 
    scale_fill_manual(name = "Sex", values = c("female" = "pink", "male" = "lightblue",
                                               "unknown" = "#FFC926", "missing" = "purple")) +
    scale_colour_manual(name = "Flagged", values = c("NA" = NA, "TRUE" = "black")) +
    # Plot seasonal length models for each species
    geom_line(data = lw.df.sub, aes(L, W), alpha = 0.75, colour = "gray50", linetype = 'dashed') +
    # Plot individuals with missing lengths and weights
    geom_point(data = filter(lengths.sub, missing.length == TRUE), 
               aes(totalLength_mm, weightg, label = label),
               shape = 21, fill = 'red',  size = 2.5, colour = NA, alpha = 0.5) +
    geom_point(data = filter(lengths.sub, missing.weight == TRUE), 
               aes(totalLength_mm, weightg, label = label),
               shape = 21, fill = 'blue', size = 2.5, colour = NA, alpha = 0.5) +
    # Format plot
    xlab("Total length (mm)") + ylab("Mass (g)") 
  
  ggplotly(lw.plot, dynamicTicks = TRUE) 
} else {
  print("No specimens present.")
}
```

## Pacific herring

```{r herring-data}
# Select species
scientificName.sub <- "Clupea pallasii"

# Subset lengths and models
lengths.sub     <- filter(lengths, scientificName == scientificName.sub)
lengths.all.sub <- filter(lengths.all, 
                          scientificName == scientificName.sub,
                          season ==  tolower(survey.season))
lw.df.sub <- filter(lw.df, scientificName == scientificName.sub)

if (nrow(lengths.sub) > 0) {
  # Plot L/W data from past and current survey -----------------------------------
  lw.plot <- ggplot() + 
    # Plot L/W data from all years/surveys
    geom_point(data = lengths.all.sub, 
               aes(totalLength_mm, weightg),
               colour = "gray70", alpha = 0.3) +
    # Plot L/W data for current survey
    geom_point(data = lengths.sub,
               aes(totalLength_mm, weightg, fill = sex, 
                   colour = outlier, label = label), 
               shape = 21, alpha = 0.9) + 
    scale_fill_manual(name = "Sex", values = c("female" = "pink", "male" = "lightblue",
                                               "unknown" = "#FFC926", "missing" = "purple")) +
    scale_colour_manual(name = "Flagged", values = c("NA" = NA, "TRUE" = "black")) +
    # Plot seasonal length models for each species
    geom_line(data = lw.df.sub, aes(L, W), alpha = 0.75, colour = "gray50", linetype = 'dashed') +
    # Plot individuals with missing lengths and weights
    geom_point(data = filter(lengths.sub, missing.length == TRUE), 
               aes(totalLength_mm, weightg, label = label),
               shape = 21, fill = 'red',  size = 2.5, colour = NA, alpha = 0.5) +
    geom_point(data = filter(lengths.sub, missing.weight == TRUE), 
               aes(totalLength_mm, weightg, label = label),
               shape = 21, fill = 'blue', size = 2.5, colour = NA, alpha = 0.5) +
    # Format plot
    xlab("Total length (mm)") + ylab("Mass (g)") 
  
  ggplotly(lw.plot, dynamicTicks = TRUE) 
} else {
  print("No specimens present.")
}
```

## Market squid

Unlike other species, the dashed line represents the results of a Loess smoother on the length and weight data from this survey, not the length-weight model from all specimens. 

```{r squid-data}
# Select species
scientificName.sub <- "Doryteuthis (Loligo) opalescens"

# Subset lengths and models
lengths.sub     <- filter(lengths, scientificName == scientificName.sub)
lengths.all.sub <- filter(lengths.all, 
                          scientificName == scientificName.sub,
                          season ==  tolower(survey.season))

if (nrow(lengths.sub) > 0) {
  # Plot L/W data from past and current survey -----------------------------------
  lw.plot <- ggplot() + 
    # Plot L/W data from all years/surveys
    geom_point(data = lengths.all.sub,
               aes(mantleLength_mm, weightg),
               colour = "gray70", alpha = 0.3) +
    # Plot L/W data for current survey
    geom_point(data = lengths.sub, aes(mantleLength_mm, weightg, fill = sex, 
                                       colour = outlier, label = label), 
               shape = 21, alpha = 0.9) + 
    scale_fill_manual(name = "Sex", values = c("female" = "pink", "male" = "lightblue",
                                               "unknown" = "#FFC926", "missing" = "purple")) +
    scale_colour_manual(name = "Flagged", values = c("NA" = NA, "TRUE" = "black")) +
    # Plot Loess smoother around data
    geom_smooth(data = lengths.sub, aes(mantleLength_mm, weightg), se = FALSE, 
                color = "gray50", alpha = 0.5, linetype = "dashed", size = 0.5) +
    # Plot individuals with missing lengths and weights
    geom_point(data = filter(lengths.sub, missing.length == TRUE), 
               aes(mantleLength_mm, weightg, label = label),
               shape = 21, fill = 'red',  size = 2.5, colour = NA) +
    geom_point(data = filter(lengths.sub, missing.weight == TRUE), 
               aes(mantleLength_mm, weightg, label = label),
               shape = 21, fill = 'blue', size = 2.5, colour = NA) +
    # Format plot
    xlab("Mantle length (mm)") + ylab("Mass (g)") 
  
  ggplotly(lw.plot, dynamicTicks = TRUE) 
} else {
  print("No specimens present.")
}
```

## Lengths by leg

```{r length-weight-leg}
# Examine length differences by leg
lw.plot.leg <- ggplot() +
  # Plot L/W data for current survey
  geom_point(data = lengths,
             aes(totalLength_mm, weightg, group = sex, fill = factor(leg)),
             shape = 21, alpha = 0.75) +
  scale_fill_viridis_d(name = "Leg") +
  # Plot individuals with missing lengths and weights
  geom_point(data = filter(lengths, missing.length == TRUE),
             aes(totalLength_mm, weightg),
             shape = 21, fill = 'red',  size = 2.5) +
  geom_point(data = filter(lengths, missing.weight == TRUE),
             aes(totalLength_mm, weightg),
             shape = 21, fill = 'blue', size = 2.5) +
  # Plot seasonal length models for each species
  geom_line(data = lw.df, aes(L, W), linetype = 'dashed', colour = "gray50", alpha = 0.75) +
  # Facet by species
  facet_wrap(~scientificName, scales = "free") +
  # Format plot
  xlab("Total length (mm)") + ylab("Mass (g)") +
  theme_bw() +
  theme(strip.background.x = element_blank(),
        strip.text.x = element_text(face = "bold.italic"))

# Save length/weight plot
ggsave(lw.plot.leg, filename = here("Figs/fig_LW_plots_leg.png"),
       width = 10, height = 7) 

# View plot
ggplotly(lw.plot.leg)
```

# Data checks
## Removed hauls  

Hauls removed due to trawl performance issues (e.g., aborted, bad, poor, etc.).

```{r bad-hauls}
haul.bad %>% 
  filter(cruise %in% cruise.name) %>%
  select(haul, trawlDate = netInWaterTime, orderOcc, trawlPerformance) %>% 
  mutate(trawlDate = date(trawlDate)) %>% 
  datatable(rownames = FALSE)
```

## Check hauls

Trawl distances are examined to look for data entry errors. Trawls longer than 5 nmi are highlighted orange.

```{r check-trawl-distance}
haul.paths %>% 
  st_set_geometry(NULL) %>% 
  arrange(haul) %>% 
  mutate(distance = cell_spec(
    distance, knitr.format, color = "black",
    background = ifelse(distance <= 5, "white", "orange"))) %>%
  # select(haul, distance, startLatMin:stopLongMin) %>%
  select(haul, distance) %>%
  kable(format = knitr.format, booktabs = TRUE, escape = FALSE,
        align = c("c")) %>% 
  kable_styling(bootstrap_options = c("striped","hover","condensed"),
                full_width = FALSE) %>%
  row_spec(0, align = c("c")) %>% 
  scroll_box(height = "500px")
```

## Map hauls

```{r map-hauls,out.height="8in",out.width="100%"}
# Provider tiles info: http://leaflet-extras.github.io/leaflet-providers/preview/index.html
if (exists("nav.paths.sf")) {
  leaflet() %>% 
    # Add provider tiles
    addProviderTiles(providers$Esri.OceanBasemap) %>%
    # Add nav data
    addPolylines(data = nav.paths.sf, color = "#000414", weight = 1, 
                 label = ~leg, group = "Vessel Track") %>%
    # Add trawl paths 
    addPolylines(data = haul.paths, color = c("#000000"), weight = 5, opacity = 0.8, 
                 popup = ~popup, label = ~label, 
                 group = "Trawls") %>% 
    # Add trawl catch
    addCircleMarkers(data = cluster.catch.sf, radius = 5, color = "#000000", stroke = TRUE, weight = 2,
                     opacity = 0.8, fillOpacity = 1, fillColor =  "white",
                     popup = ~popup, label = ~label,
                     group =  "Trawls")
} else {
  leaflet() %>% 
    # Add provider tiles
    addProviderTiles(providers$Esri.OceanBasemap) %>%
    # Add trawl paths 
    addPolylines(data = haul.paths, color = c("#000000"), weight = 5, opacity = 0.8, 
                 popup = ~popup, label = ~label, 
                 group = "Trawls") %>% 
    # Add trawl catch
    addCircleMarkers(data = cluster.catch.sf, radius = 5, color = "#000000", stroke = TRUE, weight = 2,
                     opacity = 0.8, fillOpacity = 1, fillColor =  "white",
                     popup = ~popup, label = ~label,
                     group =  "Trawls")
}
```

## Check clusters

Trawl haul information is summarized by cluster. Those clusters where the difference in equilibrium time between the first and last haul in a cluster is $\geq$ 12 h are highlighted in yellow and should be examined in the Haul table of the Trawl database.  

```{r check-trawl-clusters}
# Summarize trawl clusters
cluster.check <- haul %>% 
  group_by(cluster) %>% 
  summarise(
    firstHaul      = min(haul),
    lastHaul       = max(haul),
    nHauls         = length(cluster),
    firstHaulStart = min(equilibriumTime),
    lastHaulEnd    = max(haulBackTime),
    duration       = round(difftime(lastHaulEnd, 
                                    firstHaulStart, 
                                    units = 'hours'), 1)) %>% 
  mutate(firstHaulStart = format(firstHaulStart,"%m/%d/%Y %H:%M"),
         lastHaulEnd    = format(lastHaulEnd,"%m/%d/%Y %H:%M"))

# Print cluster check table
cluster.check %>% 
  mutate(duration = cell_spec(
    duration, knitr.format, color = "black",
    background = ifelse(duration <= 12,"white","orange"))) %>% 
  kable(format = knitr.format, booktabs = TRUE, escape = FALSE,
        align = c("c")) %>% 
  kable_styling(bootstrap_options = c("striped","hover","condensed"),
                full_width = FALSE) %>%
  row_spec(0, align = c("c")) %>% 
  scroll_box(height = "500px")
```

## Check catch

The subsampled weight from the **Catch** table (`subSampleWtkg`) should equal the summed weight of subsampled individuals in the **Specimen** table (`totalWtSpecimens`; i.e., `diffWt` == 0), and the subsample count from the **Catch** table (`subSampleCount`) should equal the number of subsampled individuals in the **Specimen** table (`totalCtSpecimens`; i.e., `diffCt` == 0). Hauls with unequal values are in **bold**;  count differences are highlighted in yellow and weight differences are highlighted in orange. Hauls with missing specimen lengths our counts are highlighted in red. Hauls where binned lengths were present are highlighted in green.

```{r catch-check}
# Summarize individual weights for comparison with total weight in the catch table
summ.lengths <- lengths %>% 
  group_by(scientificName, haul) %>% 
  summarise(
    totalWtSpecimens = sum(weightg)/1000,
    totalCtSpecimens = length(weightg),
    binnedLengths    = sum(binned)) %>% 
  mutate(key = paste(haul, scientificName)) 

catch <- catch %>% 
  left_join(select(spp.codes, species, scientificName, commonName)) %>% 
  filter(scientificName %in% cps.spp)

# Merge catch table with weight summary and arrange by species and haul
catch.comp <- left_join(select(catch, haul, scientificName, subSampleWtkg, subSampleCount),
                        select(summ.lengths, haul, scientificName, totalWtSpecimens,
                               totalCtSpecimens, binnedLengths)) %>%
  arrange(scientificName, haul) %>% 
  # Calculate difference between trawl subsample weight and summed weight from individual specimens
  mutate(diffWt    = subSampleWtkg - totalWtSpecimens,
         diffWtPct = abs(diffWt / subSampleWtkg * 100),
         diffCt    = subSampleCount - totalCtSpecimens) %>%
  # Reorder columns
  select(scientificName, haul, subSampleWtkg, totalWtSpecimens, diffWt, 
         diffWtPct, subSampleCount, totalCtSpecimens, diffCt, binnedLengths) %>% 
  replace(is.na(.), -999)

# Display results
catch.comp %>% 
  mutate(
    totalWtSpecimens = cell_spec(round(totalWtSpecimens, digits = 4),
                                 knitr.format, color = "black",
                                 background = ifelse(is.na(totalWtSpecimens), "red", "white")),
    totalCtSpecimens = cell_spec(round(totalCtSpecimens, digits = 4),
                                 knitr.format,color = "black",
                                 background = ifelse(is.na(totalCtSpecimens), "red", "white")),
    diffWt           = cell_spec(round(diffWt, digits = 4),
                                 knitr.format, color = "black",
                                 background = ifelse(diffWt == 0, "white", "orange")),
    diffCt           = cell_spec(diffCt, knitr.format,color = "black",
                                 background = ifelse(diffCt == 0, "white", "yellow")),
    binnedLengths    = cell_spec(binnedLengths, knitr.format,color = "black",
                                 background = ifelse(binnedLengths == 0, "white", "#FFC926"))) %>%
  kable(format = knitr.format,booktabs = TRUE, escape = FALSE,
        align = c("c","l",rep("r",ncol(catch.comp) - 2)),
        digits = c(0,0,3,3,4,0,0,0,0),
        format.args = list(big.mark = ",")) %>% 
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = FALSE) %>%
  column_spec(1, italic = TRUE) %>%
  row_spec(which(catch.comp$diffCt != 0), bold = TRUE) %>%
  row_spec(which(catch.comp$diffWt != 0), bold = TRUE) %>%
  row_spec(0, align = c("c")) %>%
  collapse_rows(columns = 1) %>% 
  scroll_box(height = "500px")
```

## Catch errors

This table includes only those hauls where `diffWt` and `diffCt` are not equal to zero.

```{r catch-errors}
# Filter hauls with diffCt or diffWt != zero
catch.comp.errors <- catch.comp %>% 
  filter(diffCt != 0 | diffWt != 0 | is.na(totalCtSpecimens) | is.na(totalWtSpecimens)) 

# Save output to CSV
if (nrow(catch.comp.errors) > 0) {
  write.csv(catch.comp.errors, file = here("Output/catch_comparison_errors.csv"),
            quote = FALSE, row.names = FALSE)
  
  # Display results
  catch.comp %>% 
    filter(diffCt != 0 | diffWt != 0 | is.na(totalCtSpecimens) | is.na(totalWtSpecimens)) %>% 
    mutate(
      totalWtSpecimens = cell_spec(round(totalWtSpecimens, digits = 4),
                                   knitr.format, color = "black",
                                   background = ifelse(is.na(totalWtSpecimens), "red", "white")),
      totalCtSpecimens = cell_spec(round(totalCtSpecimens, digits = 4),
                                   knitr.format,color = "black",
                                   background = ifelse(is.na(totalCtSpecimens), "red", "white")),
      diffWt           = cell_spec(round(diffWt, digits = 4),
                                   knitr.format, color = "black",
                                   background = ifelse(diffWt == 0, "white", "orange")),
      diffCt           = cell_spec(diffCt, knitr.format, color = "black",
                                   background = ifelse(diffCt == 0, "white", "yellow")),
      binnedLengths    = cell_spec(binnedLengths, knitr.format, color = "black",
                                   background = ifelse(binnedLengths == 0, "white", "green"))) %>% 
    kable(format = knitr.format, booktabs = TRUE, escape = FALSE,
          align = c("c","l",rep("r",ncol(catch.comp) - 2)),
          digits = c(0,0,3,3,4,0,0,0,0),
          format.args = list(big.mark = ",")) %>% 
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
    column_spec(1, italic = TRUE) %>%
    row_spec(0, align = c("c")) %>%
    collapse_rows(columns = 1) %>% 
    scroll_box(height = "250px") 
  
} else {
  print("Hooray, no (obvious) errors!")
}
```

